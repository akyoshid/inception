# ============================================================================
# Docker Compose Configuration for Inception Project
# ============================================================================

# ============================================================================
# SERVICES
# ============================================================================

services:

  # ==========================================================================
  # MariaDB Service
  # ==========================================================================
  mariadb:
    # Container name: The name that can be referenced inside Docker
    container_name: mariadb
    
    # Image build settings
    build:
      # Directory containing the Dockerfile
      context: ./requirements/mariadb
      # Name of the Dockerfile to use
      dockerfile: Dockerfile
    
    # Image name (name of the image after build)
    # Project requirement: must be the same name as the service
    image: mariadb
    
    # Setting environment variables (excluding sensitive information)
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
    
    # Docker Secrets configuration
    # Use secrets for sensitive information such as passwords
    # These files are mounted at /run/secrets/<secret_name>
    secrets:
      - db_root_password
      - db_password
    
    # Volume mount
    # Mount the host directory to persist data
    volumes:
      # Mount the named volume 'db_data' at /var/lib/mysql
      # MariaDB's data files are stored here
      # Data remains even if the container is removed
      - type: bind
        source: ${DB_DATA_DIR}
        target: /var/lib/mysql
    
    # Attach this service to the custom user-defined network "inception"
    # Note:
    #   Docker Compose automatically creates an isolated network per
    #   compose project, so services could communicate even without
    #   explicitly defining one.
    #   Here we define and name the network explicitly ("inception") to:
    #     - make the network name stable and predictable
    #     - emphasize that all project containers must communicate only
    #       over this isolated network
    networks:
      - inception
    
    # Behavior when a container crashes
    # unless-stopped: always attempt to restart until manually stopped
    # project requirement:
    #  "containers must restart automatically in case of a crash"
    restart: unless-stopped

  # ==========================================================================
  # WordPress Service
  # ==========================================================================
  wordpress:
    container_name: wordpress
    build:
      context: ./requirements/wordpress
      dockerfile: Dockerfile
    image: wordpress
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_HOST: mariadb
      DOMAIN_NAME: ${DOMAIN_NAME}
      WP_ADMIN_USER: ${WP_ADMIN_USER}
      WP_ADMIN_EMAIL: ${WP_ADMIN_EMAIL}
      WP_USER: ${WP_USER}
      WP_USER_EMAIL: ${WP_USER_EMAIL}
      WP_TITLE: ${WP_TITLE}
    secrets:
      - db_password
      - wp_admin_password
      - wp_user_password

    # Mount WordPress files (shared with NGINX container)
    volumes:
      - type: bind
        source: ${WP_DATA_DIR}
        target: /var/www/html

    networks:
      - inception
    
    # Wait for MariaDB to start first
    depends_on:
      - mariadb

    restart: unless-stopped

  # ==========================================================================
  # NGINX Service
  # ==========================================================================
  nginx:
    container_name: nginx
    build:
      context: ./requirements/nginx
      dockerfile: Dockerfile
      # Pass build-time arguments
      args:
        DOMAIN_NAME: ${DOMAIN_NAME}
    image: nginx

    # Pass runtime environment variables
    environment:
      DOMAIN_NAME: ${DOMAIN_NAME}

    # Port mapping: host:container
    # Only port 443 is exposed
    ports:
      - "443:443"

    # Mount WordPress files (shared with WordPress container)
    volumes:
      - type: bind
        source: ${WP_DATA_DIR}
        target: /var/www/html

    networks:
      - inception
    depends_on:
      - wordpress
    restart: unless-stopped

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  inception:
    driver: bridge
    name: inception

# ============================================================================
# SECRETS
# ============================================================================
# Definition of Docker Secrets
# Secrets are mounted inside the container at /run/secrets/<secret_name>
secrets:
  db_root_password:
    file: ../secrets/db_root_password.txt
  
  db_password:
    file: ../secrets/db_password.txt

  wp_admin_password:
    file: ../secrets/wp_admin_password.txt
  
  wp_user_password:
    file: ../secrets/wp_user_password.txt
